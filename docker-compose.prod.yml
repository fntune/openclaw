services:
  openclaw-gateway:
    image: gcr.io/${GCP_PROJECT_ID:-jarvis-ml-dev}/openclaw-gateway:${IMAGE_TAG:-latest}
    env_file: .env
    environment:
      HOME: /home/node
      TERM: xterm-256color
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY}
      SLACK_BOT_TOKEN: ${SLACK_BOT_TOKEN}
      SLACK_APP_TOKEN: ${SLACK_APP_TOKEN}
      VRM_ADMIN_API_KEY: ${VRM_ADMIN_API_KEY}
      VRM_ADMIN_API_URL: ${VRM_ADMIN_API_URL:-http://mock-api:3001}
      JARVIS_URL: ${JARVIS_URL}
      JARVIS_API_KEY: ${JARVIS_API_KEY}
      MCP_MINER_URL: ${MCP_MINER_URL:-https://miner-dot-jarvis-ml-dev.uc.r.appspot.com/mcp/}
      MCP_MINER_API_KEY: ${MCP_MINER_API_KEY}
    volumes:
      - /mnt/openclaw-data/.openclaw:/home/node/.openclaw
      - /mnt/openclaw-data/logs:/tmp/openclaw
    ports:
      - "18789:18789"
      - "18790:18790"
    init: true
    restart: unless-stopped
    depends_on:
      mock-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:18789/health').then(r=>{process.exit(r.ok?0:1)}).catch(()=>process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 45s
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
    command:
      [
        "node",
        "dist/index.js",
        "gateway",
        "--bind",
        "lan",
        "--port",
        "18789",
      ]

  mock-api:
    image: gcr.io/${GCP_PROJECT_ID:-jarvis-ml-dev}/vrm-mock-api:${IMAGE_TAG:-latest}
    env_file: .env
    environment:
      PORT: "3001"
      VRM_ADMIN_API_KEY: ${VRM_ADMIN_API_KEY}
    ports:
      - "3001:3001"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3001/health').then(r=>{process.exit(r.ok?0:1)}).catch(()=>process.exit(1))"]
      interval: 30s
      timeout: 5s
      retries: 3
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
